<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="Coding Change Our Life">
<meta property="og:type" content="website">
<meta property="og:title" content="Mervyn&#39;s Blog">
<meta property="og:url" content="https://www.mervyntang.com/page/5/index.html">
<meta property="og:site_name" content="Mervyn&#39;s Blog">
<meta property="og:description" content="Coding Change Our Life">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Mervyn&#39;s Blog">
<meta name="twitter:description" content="Coding Change Our Life">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://www.mervyntang.com/page/5/">





  <title>Mervyn's Blog</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?05d754b9fcfd6144ad1210688d2c72d8";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Mervyn's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.mervyntang.com/220.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mervyn">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mervyn's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/220.html" itemprop="url">HTTP权威指南笔记-状态码</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-06-12T00:16:00+08:00">
                2018-06-12
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HTTP/" itemprop="url" rel="index">
                    <span itemprop="name">HTTP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>HTTP状态码被分为了五大类。下边针对这五大类进行了总结</p>
<h2 id="100-199-信息性状态码"><a href="#100-199-信息性状态码" class="headerlink" title="100~199 信息性状态码"></a>100~199 信息性状态码</h2><table>
<thead>
<tr>
<th>状态码</th>
<th>原因短语</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>100</td>
<td>continue</td>
<td>说明收到了请求的初始部分，请客户端继续，发送了这个状态码之后，服务器在收到请求之后必须进行相应。</td>
</tr>
<tr>
<td>101</td>
<td>Switching Protocols</td>
<td>说明服务器正在根据客户端的指定，将协议切换成Update首部所列的协议</td>
</tr>
</tbody>
</table>
<p><code>100 continue</code> 状态码的目的是对这样的情况进行优化：HTTP客户端应用程序有一个实体的主体部分要发送给服务器，但希望在发送之前查看一下服务器是否会接受这个实体。</p>
<p>如果客户端在向服务器发送一个实体，并且愿意在发送实体之前等待 <code>100 continue</code> 响应，那么，客户端就要发送一个携带了值为 <code>100 continue</code> 的 <code>Except</code> 请求首部。</p>
<p>客户端应用程序只有在避免向服务器发送一个服务器无法处理或使用的大实体时，才应该使用 <code>100 continue</code> 。</p>
<h2 id="200-299-成功状态码"><a href="#200-299-成功状态码" class="headerlink" title="200~299 成功状态码"></a>200~299 成功状态码</h2><table>
<thead>
<tr>
<th>状态码</th>
<th>原因短语</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>200</td>
<td>OK</td>
<td>请求没问题</td>
</tr>
<tr>
<td>201</td>
<td>Created</td>
<td>用于创建服务器对象的请求（如：PUT）。响应的实体部分中应该包含各种引用了已创建的资源的URL，Location首部包含的则是最具体的引用。服务器必须在发送这个状态码之前创建好对象</td>
</tr>
<tr>
<td>202</td>
<td>Accepted</td>
<td>请求已被接受，但服务器还未对其执行任何动作。不能保证服务器会完成这个请求，这只是意味着接受请求时，它看看起来是有效的。服务器应该在实体的主体部分包含对请求状态的描述，或者还应该有对请求完成时间的估计（或者包含一个指针，指向可以获取此信息的位置）</td>
</tr>
<tr>
<td>203</td>
<td>Non-Authoritative Information</td>
<td>实体首部包含的信息不是来源于源端服务器，而是来自资源的一份副本。如果中间节点上有一份资源副本，但无法或者没有对它所发送的与资源有关的元信息进行验证，就会出现这种情况。</td>
</tr>
<tr>
<td>204</td>
<td>No Content</td>
<td>响应报文中包含若干首部和一个状态行，但没有实体的主体部分，主要用于浏览器不转为显示新文档的情况下，对其进行更新。</td>
</tr>
<tr>
<td>205</td>
<td>Reset Content</td>
<td>另一个主要用于浏览器的代码，负责告知浏览器清除当前页面中的所有HTML表单元素</td>
</tr>
<tr>
<td>206</td>
<td>Partial Content</td>
<td>成功执行了一个部分或Range请求。<br>206响应必须包含Content-Range，Date及ETag或者Content-Location首部</td>
</tr>
</tbody>
</table>
<h2 id="300-399-重定向状态码"><a href="#300-399-重定向状态码" class="headerlink" title="300~399 重定向状态码"></a>300~399 重定向状态码</h2><table>
<thead>
<tr>
<th>状态码</th>
<th>原因短语</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>300</td>
<td>Multiple Choices</td>
<td>客户端请求一个实际指向多个资源的URL时会返回这个状态码，比如服务器上有某个html文档的英语和法语版本。返回这个代码时回带有一个选项列表；这样用户就可以选择他希望使用的那一项了。有多个版本可用时，客户端需要沟通解决。服务器可以在Location首部包含首选URL</td>
</tr>
<tr>
<td>301</td>
<td>Move Permanently</td>
<td>在请求的URL已被移除时使用。响应的Location首部中应该包含资源现在所处的URL</td>
</tr>
<tr>
<td>302</td>
<td>Found</td>
<td>与301状态码类似；但是，客户端应该使用Location首部给出的URL来临时定位资源，将来的请求应仍使用老的URL</td>
</tr>
<tr>
<td>303</td>
<td>See Other</td>
<td>告知客户端应该使用另一个URL来获取资源。新的URL位于响应报文的Location首部。其主要目的是允许POST请求的响应将客户端定向到某个资源上去</td>
</tr>
<tr>
<td>304</td>
<td>Not Modified</td>
<td>客户端可以通过所包含的请求首部，使其请求编程有条件的。如果客户端发起一个条件GET请求，而最近资源未被修改的话，就可以使用这个状态码来说明资源未被修改。带有这个状态码的响应不应该包含实体的主体部分</td>
</tr>
<tr>
<td>305</td>
<td>Use Proxy</td>
<td>用来说明必须通过一个代理来访问资源；代理的位置由Location首部给出。客户端是相对某个特定资源来解析这条响应的，不能假定所有请求。如果客户端错误的让代理介入了某条请求，可能会引发破坏性行为，而且会造成安全漏洞</td>
</tr>
<tr>
<td>306</td>
<td>(未使用)</td>
<td>当前未使用</td>
</tr>
<tr>
<td>307</td>
<td>Temporary Redirect</td>
<td>与301类似；但客户端使用Location首部给出的URL来临时定位资源。将来的请求使用老的URL</td>
</tr>
</tbody>
</table>
<h2 id="400-499-客户端错误状态码"><a href="#400-499-客户端错误状态码" class="headerlink" title="400 ~ 499 客户端错误状态码"></a>400 ~ 499 客户端错误状态码</h2><table>
<thead>
<tr>
<th>状态码</th>
<th>原因短语</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>400</td>
<td>Bad Request</td>
<td></td>
</tr>
<tr>
<td>401</td>
<td>Unauthorized</td>
<td></td>
</tr>
<tr>
<td>402</td>
<td>Payment Required</td>
<td></td>
</tr>
<tr>
<td>403</td>
<td>Forbidden</td>
<td></td>
</tr>
<tr>
<td>404</td>
<td>Not Found</td>
<td></td>
</tr>
<tr>
<td>405</td>
<td>Method Not Allow</td>
<td></td>
</tr>
<tr>
<td>406</td>
<td>Not Acceptable</td>
<td></td>
</tr>
<tr>
<td>407</td>
<td>Proxy Authentication Required</td>
<td></td>
</tr>
<tr>
<td>408</td>
<td>Request Timeout</td>
<td></td>
</tr>
<tr>
<td>409</td>
<td>Conflict</td>
<td></td>
</tr>
<tr>
<td>410</td>
<td>Gone</td>
<td></td>
</tr>
<tr>
<td>411</td>
<td>Length Required</td>
<td></td>
</tr>
<tr>
<td>412</td>
<td>Procondition Failed</td>
<td></td>
</tr>
<tr>
<td>413</td>
<td>Request Entity Too Large</td>
<td></td>
</tr>
<tr>
<td>414</td>
<td>Request URI Too Long</td>
<td></td>
</tr>
<tr>
<td>415</td>
<td>Unsupported Media Type</td>
<td></td>
</tr>
<tr>
<td>416</td>
<td>Requested Range Not Satisfiable</td>
<td></td>
</tr>
<tr>
<td>417</td>
<td>Expectation Failed</td>
</tr>
</tbody>
</table>
<h2 id="500-599-服务器错误状态码"><a href="#500-599-服务器错误状态码" class="headerlink" title="500 ~ 599 服务器错误状态码"></a>500 ~ 599 服务器错误状态码</h2><table>
<thead>
<tr>
<th>状态码</th>
<th>原因短语</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>500</td>
<td>Internal Server Error</td>
<td></td>
</tr>
<tr>
<td>501</td>
<td>Not Implemented</td>
<td></td>
</tr>
<tr>
<td>502</td>
<td>Bad Gateway</td>
<td></td>
</tr>
<tr>
<td>503</td>
<td>Service Unavailable</td>
<td></td>
</tr>
<tr>
<td>504</td>
<td>Gateway Timeout</td>
<td></td>
</tr>
<tr>
<td>505</td>
<td>HTTP Version Not Supported</td>
</tr>
</tbody>
</table>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.mervyntang.com/110.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mervyn">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mervyn's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/110.html" itemprop="url">CGI , FastCGI , PHP-CGI 与 PHP-FPM 对比</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-06T00:00:00+08:00">
                2018-04-06
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/" itemprop="url" rel="index">
                    <span itemprop="name">PHP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="CGI"><a href="#CGI" class="headerlink" title="CGI"></a>CGI</h2><p>CGI全称是“公共网关接口” ( Common Gateway Interface )，HTTP服务器与你的或其它机器上的程序进行“交谈”的一种工具，其程序须运行在网络服务器上。</p>
<p>CGI可以用任何一种语言编写，只要这种语言具有标准输入、输出和环境变量。如 php , perl 等。</p>
<h2 id="FastCGI"><a href="#FastCGI" class="headerlink" title="FastCGI"></a>FastCGI</h2><p>FastCGI 像是一个常驻 ( long-live ) 型的CGI，它可以一直执行着，只要激活后，不会每次都要花费时间去fork一次（这是 CGI 最为人诟病的 fork-and-execute 模式）。它还支持分布式的运算，即 FastCGI 程序可以在网站服务器以外的主机3上执行并且接受来自其它网站服务器来的请求。</p>
<p>FastCGI是语言无关的、可伸缩架构的CGI开放扩展，其主要行为是将 CGI 解释器进程保持在内存中并因此获得较高的性能。众所周知，CGI 解释器的反复加载是 CGI 性能低下的主要原因，如果 CGI 解释器保持在内存中并接受FastCGI进程管理器调度，则可以提供良好的性能、伸缩性、Fail-Over 特性等等。</p>
<h3 id="FastCGI特点"><a href="#FastCGI特点" class="headerlink" title="FastCGI特点"></a>FastCGI特点</h3><ol>
<li>FastCGI具有语言无关性.</li>
<li>FastCGI在进程中的应用程序，独立于核心web服务器运行，提供了一个比API更安全的环境。APIs把应用程序的代码与核心的web服务器链接在一起，这意味着在一个错误的API的应用程序可能会损坏其他应用程序或核心服务器。 恶意的API的应用程序代码甚至可以窃取另一个应用程序或核心服务器的密钥。</li>
<li>FastCGI技术目前支持语言有：C/C++、Java 、Perl 、Python 、SmallTalk、Ruby 等。相关模块在 Apache, ISS, Lighttpd等流行的服务器上也是可用的。</li>
<li>FastCGI 的不依赖于任何Web服务器的内部架构，因此即使服务器技术的变化, FastCGI 依然稳定不变。</li>
</ol>
<h3 id="FastCGI的工作原理"><a href="#FastCGI的工作原理" class="headerlink" title="FastCGI的工作原理"></a>FastCGI的工作原理</h3><ol>
<li>Web Server启动时载入FastCGI 进程管理器（IIS ISAPI或Apache Module)</li>
<li>FastCGI 进程管理器自身初始化，启动多个 CGI 解释器进程(可见多个 php-cgi )并等待来自Web Server的连接。</li>
<li>当客户端请求到达 Web Server 时，FastCGI 进程管理器选择并连接到一个 CGI 解释器。Web server将CGI环境变量和标准输入发送到FastCGI子进程 php-cgi。</li>
<li>FastCGI 子进程完成处理后将标准输出和错误信息从同一连接返回 Web Server。当 FastCGI 子进程关闭连接时，请求便告处理完成。FastCGI 子进程接着等待并处理来自 FastCGI 进程管理器(运行在 Web Server 中)的下一个连接。 在 CGI 模式中，php-cgi在此便退出了。</li>
</ol>
<p>在上述情况中，你可以想象 CGI 通常有多慢。每一个Web请求 PHP 都必须重新解析 php.ini、重新载入全部扩展并重初始化全部数据结构。使用 FastCGI，所有这些都只在进程启动时发生一次。一个额外的好处是，持续数据库连接(Persistent database connection)可以工作。</p>
<p>FastCGI的不足</p>
<p>因为是多进程，所以比CGI多线程消耗更多的服务器内存，PHP-CGI解释器每进程消耗7至25兆内存，将这个数字乘以50或100就是很大的内存数。</p>
<p>Nginx 0.8.46+PHP 5.2.14(FastCGI)服务器在3万并发连接下，开启的10个Nginx进程消耗150M内存（15M<em>10=150M），开启的64个php-cgi进程消耗1280M内存（20M</em>64=1280M），加上系统自身消耗的内存，总共消耗不到2GB内存。如果服务器内存较小，完全可以只开启25个php-cgi进程，这样php-cgi消耗的总内存数才500M。</p>
<p>上面的数据摘自Nginx 0.8.x + PHP 5.2.13(FastCGI)搭建胜过Apache十倍的Web服务器</p>
<h2 id="PHP-CGI"><a href="#PHP-CGI" class="headerlink" title="PHP-CGI"></a>PHP-CGI</h2><p>PHP-CGI是PHP自带的FastCGI管理器。</p>
<h3 id="PHP-CGI的不足"><a href="#PHP-CGI的不足" class="headerlink" title="PHP-CGI的不足"></a>PHP-CGI的不足</h3><ol>
<li>php-cgi变更php.ini配置后需重启php-cgi才能让新的php-ini生效，不可以平滑重启。</li>
<li>直接杀死php-cgi进程，php就不能运行了。(PHP-FPM和Spawn-FCGI就没有这个问题，守护进程会平滑从新生成新的子进程。）</li>
</ol>
<h2 id="PHP-FPM"><a href="#PHP-FPM" class="headerlink" title="PHP-FPM"></a>PHP-FPM</h2><p>PHP-FPM是一个PHP FastCGI管理器，是只用于PHP的，可以在 <a href="http://php-fpm.org/download下载得到。" rel="external nofollow noopener noreferrer" target="_blank">http://php-fpm.org/download下载得到。</a></p>
<p>PHP-FPM其实是PHP源代码的一个补丁，旨在将FastCGI进程管理整合进PHP包中。必须将它patch到你的PHP源代码中，在编译安装PHP后才可以使用。</p>
<p>现在我们可以在PHP 5.3.2的源码树里下载得到直接整合了PHP-FPM的分支，据说下个版本会融合进PHP的主分支去。相对Spawn-FCGI，PHP-FPM在CPU和内存方面的控制都更胜一筹，而且前者很容易崩溃，必须用crontab进行监控，而PHP-FPM则没有这种烦恼。</p>
<p>PHP5.3.3已经集成php-fpm了，不再是第三方的包了。PHP-FPM提供了更好的PHP进程管理方式，可以有效控制内存和进程、可以平滑重载PHP配置，比spawn-fcgi具有更多有点，所以被PHP官方收录了。在./configure的时候带 –enable-fpm参数即可开启PHP-FPM。</p>
<h2 id="Spawn-FCGI"><a href="#Spawn-FCGI" class="headerlink" title="Spawn-FCGI"></a>Spawn-FCGI</h2><p>Spawn-FCGI是一个通用的FastCGI管理服务器，它是lighttpd中的一部份，很多人都用Lighttpd的Spawn-FCGI进行FastCGI模式下的管理工作，不过有不少缺点。而PHP-FPM的出现多少缓解了一些问题，但PHP-FPM有个缺点就是要重新编译，这对于一些已经运行的环境可能有不小的风险(refer)，在php 5.3.3中可以直接使用PHP-FPM了。</p>
<p>Spawn-FCGI 目前已经独成为一个项目，更加稳定一些，也给很多Web 站点的配置带来便利。已经有不少站点将它与nginx搭配来解决动态网页。</p>
<p>最新的lighttpd也没有包含这一块了(<a href="http://www.lighttpd.net/search?q=Spawn-FCGI)，但可以在以前版本中找到它。在lighttpd-1.4.15版本中就包含了(http://www.lighttpd.net/download/lighttpd-1.4.15.tar.gz)，目前Spawn-FCGI的下载地址是http://redmine.lighttpd.net/projects/spawn-fcgi" rel="external nofollow noopener noreferrer" target="_blank">http://www.lighttpd.net/search?q=Spawn-FCGI)，但可以在以前版本中找到它。在lighttpd-1.4.15版本中就包含了(http://www.lighttpd.net/download/lighttpd-1.4.15.tar.gz)，目前Spawn-FCGI的下载地址是http://redmine.lighttpd.net/projects/spawn-fcgi</a></p>
<p>注：最新的Spawn-FCGI可以到lighttpd.net网站搜索“Spawn-FCGI”找到它的最新版本发布地址。</p>
<h2 id="PHP-FPM与spawn-CGI对比"><a href="#PHP-FPM与spawn-CGI对比" class="headerlink" title="PHP-FPM与spawn-CGI对比"></a>PHP-FPM与spawn-CGI对比</h2><p>PHP-FPM 的使用非常方便，配置都是在PHP-FPM.ini的文件内，而启动、重启都可以从php/sbin/PHP-FPM中进行。更方便的是修改php.ini后可以直接使用PHP-FPM reload进行加载，无需杀掉进程就可以完成php.ini的修改加载</p>
<p>结果显示使用PHP-FPM可以使php有不小的性能提升。PHP-FPM控制的进程cpu回收的速度比较慢,内存分配的很均匀。</p>
<p>Spawn-FCGI控制的进程CPU下降的很快，而内存分配的比较不均匀。有很多进程似乎未分配到，而另外一些却占用很高。可能是由于进程任务分配的不均匀导致的。而这也导致了总体响应速度的下降。而PHP-FPM合理的分配，导致总体响应的提到以及任务的平均。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.mervyntang.com/89.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mervyn">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mervyn's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/89.html" itemprop="url">Elasticsearch 5.x 启动报错解决办法</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-02-27T15:50:00+08:00">
                2018-02-27
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/NoSQL/" itemprop="url" rel="index">
                    <span itemprop="name">NoSQL</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Elasticsearch-5-x-启动报错解决办法"><a href="#Elasticsearch-5-x-启动报错解决办法" class="headerlink" title="Elasticsearch 5.x 启动报错解决办法"></a>Elasticsearch 5.x 启动报错解决办法</h1><h2 id="can-not-run-elasticsearch-as-root"><a href="#can-not-run-elasticsearch-as-root" class="headerlink" title="can not run elasticsearch as root"></a>can not run elasticsearch as root</h2><p>解决方法：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">groupadd elasticsearch</span><br><span class="line">useradd elasticsearch -g elasticsearch -p elasticsearch</span><br><span class="line">chown -R elasticsearch:elasticsearch elasticsearch</span><br><span class="line">su elasticsearch  #切换到新建的用户执行启动</span><br></pre></td></tr></table></figure>
<h2 id="Elasticsearch-requires-at-least-Java-8"><a href="#Elasticsearch-requires-at-least-Java-8" class="headerlink" title="Elasticsearch requires at least Java 8"></a>Elasticsearch requires at least Java 8</h2><p>依赖:  java &gt;= 8, Only Oracle’s Java and the OpenJDK are supported. 推荐安装 1.8.0_73 or later，安装步骤如下：</p>
<ol>
<li><a href="https://www.java.com/zh_CN/download/manual.jsp" rel="external nofollow noopener noreferrer" target="_blank">https://www.java.com/zh_CN/download/manual.jsp</a>  下载对应系统的java</li>
<li>tar zxvf jre-8u131-linux-x64.tar.gz</li>
<li>将该目录放置到想要安装的目录，然后加入linux环境变量$PATH 中</li>
</ol>
<p>如果服务器有多个java环境，为了不影响其他代码，可以手动设置JAVA_HOME变量,如下：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export JAVA_HOME=/usr/local/java1.8.0</span><br></pre></td></tr></table></figure></p>
<h2 id="system-call-filters-failed-to-install-check-the-logs-and-fix-your-configuration-or-disable-system-call-filters-at-your-own-risk"><a href="#system-call-filters-failed-to-install-check-the-logs-and-fix-your-configuration-or-disable-system-call-filters-at-your-own-risk" class="headerlink" title="system call filters failed to install; check the logs and fix your configuration or disable system call filters at your own risk"></a>system call filters failed to install; check the logs and fix your configuration or disable system call filters at your own risk</h2><p>这是在因为Centos6不支持SecComp，而ES默认bootstrap.system_call_filter为true进行检测，所以导致检测失败，失败后直接导致ES不能启动。</p>
<p>解决方法：<br>在<code>elasticsearch.yml</code>中配置<code>bootstrap.system_call_filter</code>为false，注意要在Memory下面:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bootstrap.memory_lock: false</span><br><span class="line">bootstrap.system_call_filter: false</span><br></pre></td></tr></table></figure>
<h2 id="max-virtual-memory-areas-vm-max-map-count-65530-is-too-low-increase-to-at-least-262144"><a href="#max-virtual-memory-areas-vm-max-map-count-65530-is-too-low-increase-to-at-least-262144" class="headerlink" title="max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]"></a>max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -w vm.max_map_count=262144 #临时修改，重启机器后会失效</span><br></pre></td></tr></table></figure>
<p>或者采用如下方式：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/sysctl.conf</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入如下内容</span></span><br><span class="line">vm.max_map_count=262144</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 保存退出后执行</span></span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure></p>
<h2 id="max-number-of-threads-1024-for-user-elasticsearch-is-too-low-increase-to-at-least-2048"><a href="#max-number-of-threads-1024-for-user-elasticsearch-is-too-low-increase-to-at-least-2048" class="headerlink" title="max number of threads [1024] for user [elasticsearch] is too low, increase to at least [2048]"></a>max number of threads [1024] for user [elasticsearch] is too low, increase to at least [2048]</h2><p>解决方法：<br>vi /etc/security/limits.d/90-nproc.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*          soft    nproc     1024  # 1024改为2048</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.mervyntang.com/53.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mervyn">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mervyn's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/53.html" itemprop="url">Elasticsearch高级应用-聚合</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-02-27T15:40:00+08:00">
                2018-02-27
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/NoSQL/" itemprop="url" rel="index">
                    <span itemprop="name">NoSQL</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Elasticsearch高级应用-聚合"><a href="#Elasticsearch高级应用-聚合" class="headerlink" title="Elasticsearch高级应用-聚合"></a>Elasticsearch高级应用-聚合</h1><h2 id="聚合的分类"><a href="#聚合的分类" class="headerlink" title="聚合的分类"></a>聚合的分类</h2><ul>
<li><p>度量聚合</p>
<p>在一组文档中队某个数字型字段进行计算得出指标值</p>
</li>
<li><p>分组聚合</p>
<p>创建多个分组，每个分组关联一个关键字和相关文档标准</p>
</li>
<li><p>管道聚合</p>
<p>这一类的聚合的数据源是其他聚合的输出，然后进行相关指标的计算</p>
</li>
</ul>
<h3 id="度量聚合"><a href="#度量聚合" class="headerlink" title="度量聚合"></a>度量聚合</h3><h4 id="平均值聚合"><a href="#平均值聚合" class="headerlink" title="平均值聚合"></a>平均值聚合</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET 'http://127.0.0.1:9200/aggreation_test/student/_search?pretty' -d '</span><br><span class="line">&#123;</span><br><span class="line">    "size":0,</span><br><span class="line">    "aggs":&#123;</span><br><span class="line">        "avg_score":&#123;   //聚合的名称</span><br><span class="line">            "avg":&#123;</span><br><span class="line">                "field":"socre"</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">'</span><br></pre></td></tr></table></figure>
<h4 id="最大值聚合"><a href="#最大值聚合" class="headerlink" title="最大值聚合"></a>最大值聚合</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET 'http://127.0.0.1:9200/aggreation_test/student/_search?pretty' -d '</span><br><span class="line">&#123;</span><br><span class="line">    "size":0,</span><br><span class="line">    "aggs":&#123;</span><br><span class="line">        "max_age":&#123;</span><br><span class="line">            "max":&#123;</span><br><span class="line">                "field":"age"</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">'</span><br></pre></td></tr></table></figure>
<h4 id="最小值聚合"><a href="#最小值聚合" class="headerlink" title="最小值聚合"></a>最小值聚合</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET 'http://127.0.0.1:9200/aggreation_test/student/_search?pretty' -d '</span><br><span class="line">&#123;</span><br><span class="line">    "size":0,</span><br><span class="line">    "aggs":&#123;</span><br><span class="line">        "min_socre":&#123;</span><br><span class="line">            "min":&#123;</span><br><span class="line">                "field":"socre"</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">'</span><br></pre></td></tr></table></figure>
<h4 id="百分比聚合"><a href="#百分比聚合" class="headerlink" title="百分比聚合"></a>百分比聚合</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET 'http://127.0.0.1:9200/aggreation_test/student/_search?pretty' -d '</span><br><span class="line">&#123;</span><br><span class="line">    "size":0,</span><br><span class="line">    "aggs":&#123;</span><br><span class="line">        "score":&#123;</span><br><span class="line">            "percentiles":&#123;</span><br><span class="line">                "field":"socre",</span><br><span class="line">                "percents":[50] //默认的百分比指标为[1, 5, 25, 50, 75, 95, 99]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">'</span><br></pre></td></tr></table></figure>
<p>返回结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"took"</span> : <span class="number">12</span>,</span><br><span class="line">  <span class="attr">"timed_out"</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"_shards"</span> : &#123;</span><br><span class="line">    <span class="attr">"total"</span> : <span class="number">5</span>,</span><br><span class="line">    <span class="attr">"successful"</span> : <span class="number">5</span>,</span><br><span class="line">    <span class="attr">"failed"</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"hits"</span> : &#123;</span><br><span class="line">    <span class="attr">"total"</span> : <span class="number">10</span>,</span><br><span class="line">    <span class="attr">"max_score"</span> : <span class="number">0.0</span>,</span><br><span class="line">    <span class="attr">"hits"</span> : [ ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"aggregations"</span> : &#123;</span><br><span class="line">    <span class="attr">"score"</span> : &#123;</span><br><span class="line">      <span class="attr">"values"</span> : &#123;</span><br><span class="line">        <span class="attr">"1.0"</span> : <span class="number">66.63</span>,</span><br><span class="line">        <span class="attr">"5.0"</span> : <span class="number">69.15</span>,</span><br><span class="line">        <span class="attr">"25.0"</span> : <span class="number">81.0</span>,</span><br><span class="line">        <span class="attr">"50.0"</span> : <span class="number">84.5</span>,</span><br><span class="line">        <span class="attr">"75.0"</span> : <span class="number">99.0</span>,</span><br><span class="line">        <span class="attr">"95.0"</span> : <span class="number">111.0</span>,</span><br><span class="line">        <span class="attr">"99.0"</span> : <span class="number">111.0</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>75%的分数在66.63~99.0</p>
<h3 id="分组聚合"><a href="#分组聚合" class="headerlink" title="分组聚合"></a>分组聚合</h3><h4 id="直方图聚合"><a href="#直方图聚合" class="headerlink" title="直方图聚合"></a>直方图聚合</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET 'http://127.0.0.1:9200/aggreation_test/student/_search?pretty' -d '</span><br><span class="line">&#123;</span><br><span class="line">    "size":0,</span><br><span class="line">    "aggs":&#123;</span><br><span class="line">        "score":&#123;</span><br><span class="line">            "histogram":&#123;</span><br><span class="line">                "field":"socre",</span><br><span class="line">                "interval":10,</span><br><span class="line">                "min_doc_count":0,</span><br><span class="line">                "extended_bounds":&#123;</span><br><span class="line">                  "min":0,</span><br><span class="line">                  "max":150</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">'</span><br></pre></td></tr></table></figure>
<h4 id="日期直方图聚合"><a href="#日期直方图聚合" class="headerlink" title="日期直方图聚合"></a>日期直方图聚合</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET 'http://127.0.0.1:9200/aggreation_test/device_events/_search?pretty' -d '</span><br><span class="line">&#123;</span><br><span class="line">    "size":0,</span><br><span class="line">    "aggs":&#123;</span><br><span class="line">        "by_month":&#123;</span><br><span class="line">            "date_histogram":&#123;</span><br><span class="line">                "field":"ctime",</span><br><span class="line">                "interval":"month",</span><br><span class="line">                "format":"yyyy-MM-dd HH:mm:ss",</span><br><span class="line">                "min_doc_count":0,</span><br><span class="line">                "extended_bounds":&#123; //会强制返回一整年的数据</span><br><span class="line">                    "min":"2017-01-01 00:00:00",</span><br><span class="line">                    "max":"2017-12-31 00:00:00"</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">'</span><br></pre></td></tr></table></figure>
<h4 id="时间范围聚合"><a href="#时间范围聚合" class="headerlink" title="时间范围聚合"></a>时间范围聚合</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET 'http://127.0.0.1:9200/aggreation_test/device_events/_search?pretty' -d '</span><br><span class="line">&#123;</span><br><span class="line">    "size":10,</span><br><span class="line">    "aggs":&#123;</span><br><span class="line">        "by_month":&#123;</span><br><span class="line">            "date_range":&#123;</span><br><span class="line">                "field":"ctime",</span><br><span class="line">                "format":"yyyy-MM-dd HH:mm:ss",</span><br><span class="line">                "ranges":[</span><br><span class="line">                    &#123;"to":"now-10M/M"&#125;,     //10月内的数据</span><br><span class="line">                    &#123;"from":"now-10M/M"&#125;    //近10个月前的数据</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">'</span><br></pre></td></tr></table></figure>
<h4 id="范围聚合"><a href="#范围聚合" class="headerlink" title="范围聚合"></a>范围聚合</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET 'http://127.0.0.1:9200/aggreation_test/order/_search?pretty' -d '</span><br><span class="line">&#123;</span><br><span class="line">    "size":10,</span><br><span class="line">    "aggs":&#123;</span><br><span class="line">        "by_month":&#123;</span><br><span class="line">            "range":&#123;</span><br><span class="line">                "field":"money",</span><br><span class="line">                "ranges":[</span><br><span class="line">                    &#123;"to":3036&#125;,</span><br><span class="line">                    &#123;"from":3036, "to": 3500&#125;,</span><br><span class="line">                    &#123;"from":3000&#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">'</span><br></pre></td></tr></table></figure>
<h4 id="嵌套聚合"><a href="#嵌套聚合" class="headerlink" title="嵌套聚合"></a>嵌套聚合</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET 'http://127.0.0.1:9200/aggreation_test/order/_search?pretty' -d '</span><br><span class="line">&#123;</span><br><span class="line">    "size":0,</span><br><span class="line">    "aggs":&#123;</span><br><span class="line">        "order_lines":&#123;</span><br><span class="line">            "nested":&#123;"path":"lines"&#125;,</span><br><span class="line">            "aggs":&#123;</span><br><span class="line">                "min_price":&#123;"min":&#123;"field":"lines.price"&#125;&#125;,</span><br><span class="line">                "max_price":&#123;"max":&#123;"field":"lines.price"&#125;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">'</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET 'http://127.0.0.1:9200/aggreation_test/order/_search?pretty' -d '</span><br><span class="line">&#123;</span><br><span class="line">    "size":10,</span><br><span class="line">    "aggs":&#123;</span><br><span class="line">        "order_by_month":&#123;</span><br><span class="line">            "date_histogram":&#123;</span><br><span class="line">                "min_doc_count":1,</span><br><span class="line">                "field":"ctime",</span><br><span class="line">                "interval":"month",</span><br><span class="line">                "extended_bounds":&#123;</span><br><span class="line">                    "min":"2017-01-01 00:00:00",</span><br><span class="line">                    "max":"2017-12-31 00:00:00"</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            "aggs":&#123;</span><br><span class="line">                "lines":&#123;</span><br><span class="line">                    "nested":&#123;</span><br><span class="line">                        "path":"lines"</span><br><span class="line">                    &#125;,</span><br><span class="line">                    "aggs":&#123;</span><br><span class="line">                        "num_cout":&#123;</span><br><span class="line">                            "sum":&#123;</span><br><span class="line">                                "field":"lines.num"</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;,</span><br><span class="line">                        "sum_price":&#123;</span><br><span class="line">                            "sum":&#123;</span><br><span class="line">                                "field":"lines.price"</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">'</span><br></pre></td></tr></table></figure>
<h3 id="管道聚合"><a href="#管道聚合" class="headerlink" title="管道聚合"></a>管道聚合</h3><p>通过buckete_path 参数指定请求指标的路径，管道聚合可以引用需要的聚合来执行计算</p>
<h4 id="最大分组聚合"><a href="#最大分组聚合" class="headerlink" title="最大分组聚合"></a>最大分组聚合</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET 'http://127.0.0.1:9200/aggreation_test/order/_search?pretty' -d '</span><br><span class="line">&#123;</span><br><span class="line">    "size":0,</span><br><span class="line">    "aggs":&#123;</span><br><span class="line">        "order_by_month":&#123;</span><br><span class="line">            "date_histogram":&#123;</span><br><span class="line">                "min_doc_count":0,</span><br><span class="line">                "field":"ctime",</span><br><span class="line">                "interval":"month",</span><br><span class="line">                "extended_bounds":&#123;</span><br><span class="line">                    "min":"2017-01-01 00:00:00",</span><br><span class="line">                    "max":"2017-12-31 00:00:00"</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            "aggs":&#123;</span><br><span class="line">                "sum_money":&#123;"sum":&#123;"field":"money"&#125; &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        "max_month_sales":&#123;</span><br><span class="line">            "max_bucket":&#123;  //最大分组聚合，找出 所有月份销售总额最大值  （最小分组聚合 min_bucket）</span><br><span class="line">                "buckets_path":"order_by_month&gt;sum_money"</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">'</span><br></pre></td></tr></table></figure>
<h4 id="总和累计聚合"><a href="#总和累计聚合" class="headerlink" title="总和累计聚合"></a>总和累计聚合</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET 'http://127.0.0.1:9200/aggreation_test/device_events/_search?pretty' -d '</span><br><span class="line">&#123;</span><br><span class="line">    "size":10,</span><br><span class="line">    "aggs":&#123;</span><br><span class="line">        "per_month":&#123;</span><br><span class="line">            "date_histogram":&#123;</span><br><span class="line">                "min_doc_count":0,</span><br><span class="line">                "field":"ctime",</span><br><span class="line">                "interval":"month",</span><br><span class="line">                "extended_bounds":&#123; //会强制返回一整年的数据</span><br><span class="line">                    "min":"2017-01-01 00:00:00",</span><br><span class="line">                    "max":"2017-12-31 00:00:00"</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            "aggs":&#123;</span><br><span class="line">                "device_id":&#123;</span><br><span class="line">                    "cardinality":&#123; //语法</span><br><span class="line">                        "field":"device_id" //每月独立设备数</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                "cumulative_device":&#123;</span><br><span class="line">                    "cumulative_sum":&#123;  //语法</span><br><span class="line">                        "buckets_path":"device_id"  //按月累计设备数</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">'</span><br></pre></td></tr></table></figure>
<h4 id="差值聚合"><a href="#差值聚合" class="headerlink" title="差值聚合"></a>差值聚合</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET 'http://127.0.0.1:9200/aggreation_test/device_events/_search?pretty' -d '</span><br><span class="line">&#123;</span><br><span class="line">    "size":10,</span><br><span class="line">    "aggs":&#123;</span><br><span class="line">        "by_month":&#123;</span><br><span class="line">            "date_histogram":&#123;  //这个为固定语法</span><br><span class="line">                "min_doc_count":0,  //参数会强制返回空桶</span><br><span class="line">                "field":"ctime",</span><br><span class="line">                "interval":"month",</span><br><span class="line">                "extended_bounds":&#123; //会强制返回一整年的数据</span><br><span class="line">                    "min":"2017-01-01 00:00:00",</span><br><span class="line">                    "max":"2017-12-31 00:00:00"</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            "aggs":&#123;</span><br><span class="line">                "home":&#123;</span><br><span class="line">                    "cardinality":&#123; //去重近似值</span><br><span class="line">                        "field":"home_id"</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                "home_deriv":&#123;</span><br><span class="line">                    "derivative":&#123;  //去重近似值</span><br><span class="line">                        "buckets_path":"home"</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;'</span><br></pre></td></tr></table></figure>
<h2 id="不同场景下的聚合应用"><a href="#不同场景下的聚合应用" class="headerlink" title="不同场景下的聚合应用"></a>不同场景下的聚合应用</h2><p>下面主要以不同场景下的应用来介绍ES聚合的情况。假设现在有一张设备事件表如下结构：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`device_events `</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'# 事件ID'</span>,</span><br><span class="line">  <span class="string">`identifier`</span> <span class="built_in">tinyint</span>(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'# 事件标识'</span>,</span><br><span class="line">  <span class="string">`type`</span> <span class="built_in">tinyint</span>(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'# 事件类型'</span>,</span><br><span class="line">  <span class="string">`device_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'# 设备ID'</span>,</span><br><span class="line">  <span class="string">`home_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'# 家庭ID'</span>,</span><br><span class="line">  <span class="string">`product_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'# 设备对应的产品ID'</span>,</span><br><span class="line">  <span class="string">`user_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'# 用户ID'</span>,</span><br><span class="line">  <span class="string">`params`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'# 设备上报的参数,如：&#123;"success":1&#125;'</span>,</span><br><span class="line">  <span class="string">`ctime`</span> datetime <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'# 事件上报的时间'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">186</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span>=<span class="string">'设备事件表'</span>;</span><br></pre></td></tr></table></figure>
<p>对应ES结构如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">curl -u elastic:changeme -XPOST 'http://127.0.0.1:9200/aggreation_test/device_events'  -d'</span><br><span class="line">&#123;</span><br><span class="line">    "mappings": &#123;</span><br><span class="line">        "demo": &#123;</span><br><span class="line">            "properties": &#123;</span><br><span class="line">                "identifier": &#123;</span><br><span class="line">                    "type": "integer"</span><br><span class="line">                &#125;,</span><br><span class="line">                "event_id": &#123;</span><br><span class="line">                    "type": "integer"</span><br><span class="line">                &#125;,</span><br><span class="line">                "type": &#123;</span><br><span class="line">                    "type": "integer"</span><br><span class="line">                &#125;,</span><br><span class="line">                "device_id": &#123;</span><br><span class="line">                    "type": "integer"</span><br><span class="line">                &#125;,</span><br><span class="line">                "ctime": &#123;</span><br><span class="line">                    "type": "date",</span><br><span class="line">                    "format":"yyyy-MM-dd HH:mm:ss"</span><br><span class="line">                &#125;,</span><br><span class="line">                 "home_id": &#123;</span><br><span class="line">                    "type": "integer"</span><br><span class="line">                &#125;,</span><br><span class="line">                 "product_id": &#123;</span><br><span class="line">                    "type": "integer"</span><br><span class="line">                &#125;,</span><br><span class="line">                 "user_id": &#123;</span><br><span class="line">                    "type": "integer"</span><br><span class="line">                &#125;,</span><br><span class="line">                 "params": &#123;</span><br><span class="line">                    "type": "object",</span><br><span class="line">                    "properties":&#123;</span><br><span class="line">                        "success":&#123;</span><br><span class="line">                            "type":"integer"</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;'</span><br></pre></td></tr></table></figure>
<p>这里注意params的类型，ES里两个比较特殊的类型 <code>object</code> 和 <code>nested</code></p>
<p><code>object</code> 为对象数据类型，单独的JSON对象</p>
<p><code>nested</code>  为嵌套数据类型，关于JSON对象的数组</p>
<p>通过调用SDK批量插入一批数据，即可开始进行聚合测试。</p>
<p><strong>统计每个事件类型的数量</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET 'http://127.0.0.1:9200/aggreation_test/device_events/_search?pretty' -d '</span><br><span class="line">&#123;</span><br><span class="line">    "size":0,</span><br><span class="line">    "query":&#123;</span><br><span class="line">        "bool":&#123;</span><br><span class="line">            "must":[</span><br><span class="line">                &#123;</span><br><span class="line">                    "range":&#123;</span><br><span class="line">                        "ctime":&#123;</span><br><span class="line">                            "gt":"2016-01-01 00:00:00",</span><br><span class="line">                            "lt":"2018-08-01 00:00:00"</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    "aggs":&#123;</span><br><span class="line">        "type_percent":&#123;</span><br><span class="line">            "histogram":&#123;</span><br><span class="line">                "min_doc_count":0,      //最少要有0个文档</span><br><span class="line">                "field":"type",</span><br><span class="line">                "interval":"1"</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">'</span><br></pre></td></tr></table></figure>
<p><strong>以月为单位统计每月的事件消息数，独立设备数，独立家庭数。</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET 'http://127.0.0.1:9200/aggreation_test/device_events/_search?pretty' -d '</span><br><span class="line">&#123;</span><br><span class="line">    "size":0,</span><br><span class="line">    "query":&#123;</span><br><span class="line">        "bool":&#123;</span><br><span class="line">            "must":[</span><br><span class="line">                &#123;</span><br><span class="line">                    "range":&#123;</span><br><span class="line">                        "ctime":&#123;</span><br><span class="line">                            "gt":"2017-01-01 00:00:00",</span><br><span class="line">                            "lt":"2018-08-01 00:00:00"</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    "aggs":&#123;</span><br><span class="line">        "by_month":&#123;</span><br><span class="line">            "date_histogram":&#123;  //这个为固定语法</span><br><span class="line">                "min_doc_count":0,  //参数会强制返回空桶</span><br><span class="line">                "field":"ctime",</span><br><span class="line">                "interval":"month",</span><br><span class="line">                "extended_bounds":&#123; //会强制返回一整年的数据</span><br><span class="line">                    "min":"2017-01-01 00:00:00",</span><br><span class="line">                    "max":"2017-12-31 00:00:00"</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            "aggs":&#123;</span><br><span class="line">                "device_id":&#123;</span><br><span class="line">                    "cardinality":&#123; //去重近似值</span><br><span class="line">                        "field":"device_id"</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                "home_id":&#123;</span><br><span class="line">                    "cardinality":&#123;</span><br><span class="line">                        "field":"home_id"</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;'</span><br></pre></td></tr></table></figure>
<p><strong>以月为单位统计每月独立家庭数的差值</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET 'http://127.0.0.1:9200/aggreation_test/device_events/_search?pretty' -d '</span><br><span class="line">&#123;</span><br><span class="line">    "size":0,</span><br><span class="line">    "query":&#123;</span><br><span class="line">        "bool":&#123;</span><br><span class="line">            "must":[</span><br><span class="line">                &#123;</span><br><span class="line">                    "range":&#123;</span><br><span class="line">                        "ctime":&#123;</span><br><span class="line">                            "gt":"2017-01-01 00:00:00",</span><br><span class="line">                            "lt":"2018-08-01 00:00:00"</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    "aggs":&#123;</span><br><span class="line">        "by_month":&#123;</span><br><span class="line">            "date_histogram":&#123;  //这个为固定语法</span><br><span class="line">                "min_doc_count":0,  //参数会强制返回空桶</span><br><span class="line">                "field":"ctime",</span><br><span class="line">                "interval":"month",</span><br><span class="line">                "extended_bounds":&#123; //会强制返回一整年的数据</span><br><span class="line">                    "min":"2017-01-01 00:00:00",</span><br><span class="line">                    "max":"2017-12-31 00:00:00"</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            "aggs":&#123;</span><br><span class="line">                "home":&#123;</span><br><span class="line">                    "cardinality":&#123; //去重近似值</span><br><span class="line">                        "field":"home_id"</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                "home_deriv":&#123;</span><br><span class="line">                    "derivative":&#123;  //去重近似值</span><br><span class="line">                        "buckets_path":"home"</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;'</span><br></pre></td></tr></table></figure>
<p><strong>param参数success为1的统计</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET 'http://127.0.0.1:9200/aggreation_test/device_events/_search?pretty' -d '</span><br><span class="line">&#123;</span><br><span class="line">    "size":10,</span><br><span class="line">    "query":&#123;</span><br><span class="line">        "bool":&#123;</span><br><span class="line">            "must":[</span><br><span class="line">                &#123;</span><br><span class="line">                    "range":&#123;</span><br><span class="line">                        "ctime":&#123;</span><br><span class="line">                            "gt":"2016-01-01 00:00:00",</span><br><span class="line">                            "lt":"2018-08-01 00:00:00"</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    "term":&#123;</span><br><span class="line">                        "params.success":2</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    "aggs":&#123;</span><br><span class="line">        "device_id":&#123;</span><br><span class="line">            "cardinality":&#123;</span><br><span class="line">                "field":"device_id"</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        "home_id":&#123;</span><br><span class="line">            "cardinality":&#123;</span><br><span class="line">                "field":"home_id"</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;'</span><br></pre></td></tr></table></figure></p>
<p><strong>以月为单位计算每月累计独立设备数</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET 'http://127.0.0.1:9200/aggreation_test/device_events/_search?pretty' -d '</span><br><span class="line">&#123;</span><br><span class="line">    "size":0,</span><br><span class="line">    "query":&#123;</span><br><span class="line">        "bool":&#123;</span><br><span class="line">            "must":[</span><br><span class="line">                &#123;</span><br><span class="line">                    "range":&#123;</span><br><span class="line">                        "ctime":&#123;</span><br><span class="line">                            "gt":"2016-01-01 00:00:00",</span><br><span class="line">                            "lt":"2018-08-01 00:00:00"</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    "aggs":&#123;</span><br><span class="line">        "per_month":&#123;</span><br><span class="line">            "date_histogram":&#123;</span><br><span class="line">                "min_doc_count":0,</span><br><span class="line">                "field":"ctime",</span><br><span class="line">                "interval":"month",</span><br><span class="line">                "extended_bounds":&#123; //会强制返回一整年的数据</span><br><span class="line">                    "min":"2017-01-01 00:00:00",</span><br><span class="line">                    "max":"2017-12-31 00:00:00"</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            "aggs":&#123;</span><br><span class="line">                "device_id":&#123;</span><br><span class="line">                    "cardinality":&#123; //语法</span><br><span class="line">                        "field":"device_id"</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                "cumulative_device":&#123;</span><br><span class="line">                    "cumulative_sum":&#123;  //语法</span><br><span class="line">                        "buckets_path":"device_id"</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">'</span><br></pre></td></tr></table></figure>
<p><strong>统计参数success不同值的数量</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET 'http://127.0.0.1:9200/aggreation_test/device_events/_search?pretty' -d '</span><br><span class="line">&#123;</span><br><span class="line">    "size":0,</span><br><span class="line">    "query":&#123;</span><br><span class="line">        "bool":&#123;</span><br><span class="line">            "must":[</span><br><span class="line">                &#123;</span><br><span class="line">                    "range":&#123;</span><br><span class="line">                        "ctime":&#123;</span><br><span class="line">                            "gt":"2016-01-01 00:00:00",</span><br><span class="line">                            "lt":"2018-08-01 00:00:00"</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    "aggs":&#123;</span><br><span class="line">        "type_percent":&#123;</span><br><span class="line">            "histogram":&#123;</span><br><span class="line">                "min_doc_count":0,</span><br><span class="line">                "field":"params.success",</span><br><span class="line">                "interval":"1"</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">'</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.mervyntang.com/50.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mervyn">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mervyn's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/50.html" itemprop="url">Elasticsearch 基本用法</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-02-27T15:21:00+08:00">
                2018-02-27
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/NoSQL/" itemprop="url" rel="index">
                    <span itemprop="name">NoSQL</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Elasticsearch-基本用法"><a href="#Elasticsearch-基本用法" class="headerlink" title="Elasticsearch 基本用法"></a>Elasticsearch 基本用法</h1><p>一个 Elasticsearch 请求和任何 HTTP 请求一样由若干相同的部件组成：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X&lt;VERB&gt; &apos;&lt;PROTOCOL&gt;://&lt;HOST&gt;:&lt;PORT&gt;/&lt;PATH&gt;?&lt;QUERY_STRING&gt;&apos; -d &apos;&lt;BODY&gt;&apos;</span><br></pre></td></tr></table></figure>
<p>被 <code>&lt; &gt;</code> 标记的部件：</p>
<table>
<thead>
<tr>
<th><code>VERB</code></th>
<th>适当的 HTTP <em>方法</em> 或 <em>谓词</em> : <code>GET</code>、 <code>POST</code>、 <code>PUT</code>、 <code>HEAD</code> 或者 <code>DELETE</code>。</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>PROTOCOL</code></td>
<td><code>http</code> 或者 <code>https</code>（如果你在 Elasticsearch 前面有一个 <code>https</code> 代理）</td>
</tr>
<tr>
<td><code>HOST</code></td>
<td>Elasticsearch 集群中任意节点的主机名，或者用 <code>localhost</code> 代表本地机器上的节点。</td>
</tr>
<tr>
<td><code>PORT</code></td>
<td>运行 Elasticsearch HTTP 服务的端口号，默认是 <code>9200</code> 。</td>
</tr>
<tr>
<td><code>PATH</code></td>
<td>API 的终端路径（例如 <code>_count</code> 将返回集群中文档数量）。Path 可能包含多个组件，例如：<code>_cluster/stats</code> 和 <code>_nodes/stats/jvm</code> 。</td>
</tr>
<tr>
<td><code>QUERY_STRING</code></td>
<td>任意可选的查询字符串参数 (例如 <code>?pretty</code> 将格式化地输出 JSON 返回值，使其更容易阅读)</td>
</tr>
<tr>
<td><code>BODY</code></td>
<td>一个 JSON 格式的请求体 (如果请求需要的话)</td>
</tr>
</tbody>
</table>
<h2 id="集群重启"><a href="#集群重启" class="headerlink" title="集群重启"></a>集群重启</h2><p>1、关闭分片分配 <code>PUT /_cluster/settings</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT &apos;http://127.0.0.1:9200/_cluster/settings&apos; -d &apos;</span><br><span class="line">&#123;</span><br><span class="line">    &quot;transient&quot;:&#123;&quot;cluster.routing.allocation.enable&quot;: &quot;none&quot;&#125;</span><br><span class="line">&#125;</span><br><span class="line">&apos;</span><br></pre></td></tr></table></figure>
<p>2、 执行一个同步刷新 <code>POST /_flush/synced</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST &apos;http://127.0.0.1:9200/_flush/synced&apos;​</span><br></pre></td></tr></table></figure>
<p>3、 关闭所有节点</p>
<p>4、 优先启动主节点（ <code>node.master: true</code> ）</p>
<h2 id="node状态"><a href="#node状态" class="headerlink" title="node状态"></a>node状态</h2><ul>
<li><p>当前集群master</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@flumelog-10-10-18-177 ~]# curl -XGET 'http://127.0.0.1:9200/_cat/master?pretty=true&amp;v'</span><br><span class="line">id                     host         ip           node</span><br><span class="line">0-sR1-c4TBSPB9WbNVWzNA 10.10.18.179 10.10.18.179 node-179</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询整个集群的文档数量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@flumelog-10-10-18-177 ~]# curl -XGET 'http://127.0.0.1:9200/_cat/count?v'</span><br><span class="line">epoch      timestamp count</span><br><span class="line">1502244880 10:14:40  2635961</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看集群的健康状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@flumelog-10-10-18-177 ~]# curl -XGET 'http://127.0.0.1:9200/_cat/health?v'</span><br><span class="line">epoch      timestamp cluster          status node.total node.data shards pri relo init unassign pending_tasks max_task_wait_time active_shards_percent</span><br><span class="line">1502244979 10:16:19  spotmau_oss_test green           3         3     20  10    0    0        0             0                  -                100.0%</span><br><span class="line"></span><br><span class="line">[root@flumelog-10-10-18-177 ~]# curl -XGET 'http://127.0.0.1:9200/_cluster/health?pretty'</span><br><span class="line">&#123;</span><br><span class="line">  "cluster_name" : "spotmau_oss_test",</span><br><span class="line">  "status" : "green",</span><br><span class="line">  "timed_out" : false,</span><br><span class="line">  "number_of_nodes" : 3,</span><br><span class="line">  "number_of_data_nodes" : 3,</span><br><span class="line">  "active_primary_shards" : 10,</span><br><span class="line">  "active_shards" : 20,</span><br><span class="line">  "relocating_shards" : 0,</span><br><span class="line">  "initializing_shards" : 0,</span><br><span class="line">  "unassigned_shards" : 0,</span><br><span class="line">  "delayed_unassigned_shards" : 0,</span><br><span class="line">  "number_of_pending_tasks" : 0,</span><br><span class="line">  "number_of_in_flight_fetch" : 0,</span><br><span class="line">  "task_max_waiting_in_queue_millis" : 0,</span><br><span class="line">  "active_shards_percent_as_number" : 100.0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看索引信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@flumelog-10-10-18-177 ~]# curl -XGET 'http://127.0.0.1:9200/_cat/indices/*?v&amp;s=docs.count:desc&amp;pretty'</span><br><span class="line">health status index           uuid                   pri rep docs.count docs.deleted store.size pri.store.size</span><br><span class="line">green  open   megacorp        5Htj3xNkQV-aLSvB3GNhpw   5   1    2635951            0    174.1mb           87mb</span><br><span class="line">green  open   aggreation_test du8SNooNQZOPFRW597cj0Q   5   1         10            0     44.4kb         22.2kb</span><br></pre></td></tr></table></figure>
</li>
<li><p>集群的当前master节点信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@flumelog-10-10-18-177 ~]# curl -XGET 'http://127.0.0.1:9200/_cat/master?v'</span><br><span class="line">id                     host         ip           node</span><br><span class="line">0-sR1-c4TBSPB9WbNVWzNA 10.10.18.179 10.10.18.179 node-179</span><br></pre></td></tr></table></figure>
</li>
<li><p>集群中的节点信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@flumelog-10-10-18-177 ~]# curl -XGET 'http://127.0.0.1:9200/_cat/nodes?v'</span><br><span class="line">ip           heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name</span><br><span class="line">10.10.18.179            9          52   0    0.00    0.00     0.00 mdi       *      node-179</span><br><span class="line">127.0.0.1           16          25   0    0.00    0.00     0.00 mdi       -      node-178</span><br><span class="line">127.0.0.1           15          24   0    0.00    0.00     0.00 mdi       -      node-177</span><br></pre></td></tr></table></figure>
</li>
<li><p>集群中的shard信息</p>
<p>The <code>shards</code> command is the detailed view of what nodes contain which shards.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@flumelog-10-10-18-177 ~]# curl -XGET 'http://127.0.0.1:9200/_cat/shards?v'</span><br><span class="line">index           shard prirep state     docs  store ip           node</span><br><span class="line">megacorp        3     r      STARTED 526499 17.3mb 10.10.18.179 node-179</span><br><span class="line">megacorp        3     p      STARTED 526499 17.3mb 127.0.0.1 node-178</span><br><span class="line">megacorp        2     p      STARTED 525965 17.3mb 127.0.0.1 node-177</span><br><span class="line">megacorp        2     r      STARTED 525965 17.3mb 10.10.18.179 node-179</span><br><span class="line">megacorp        1     r      STARTED 527456 17.5mb 127.0.0.1 node-177</span><br><span class="line">megacorp        1     p      STARTED 527456 17.5mb 127.0.0.1 node-178</span><br><span class="line">megacorp        4     r      STARTED 528088 17.3mb 10.10.18.179 node-179</span><br><span class="line">megacorp        4     p      STARTED 528088 17.4mb 127.0.0.1 node-178</span><br><span class="line">megacorp        0     p      STARTED 527943 17.4mb 127.0.0.1 node-177</span><br><span class="line">megacorp        0     r      STARTED 527943 17.4mb 10.10.18.179 node-179</span><br><span class="line">aggreation_test 3     r      STARTED      2  5.3kb 10.10.18.179 node-179</span><br><span class="line">aggreation_test 3     p      STARTED      2  5.3kb 127.0.0.1 node-178</span><br><span class="line">aggreation_test 2     r      STARTED      3  5.6kb 127.0.0.1 node-177</span><br><span class="line">aggreation_test 2     p      STARTED      3  5.6kb 127.0.0.1 node-178</span><br><span class="line">aggreation_test 1     r      STARTED      4  5.9kb 127.0.0.1 node-177</span><br><span class="line">aggreation_test 1     p      STARTED      4  5.9kb 127.0.0.1 node-178</span><br><span class="line">aggreation_test 4     r      STARTED      1    5kb 10.10.18.179 node-179</span><br><span class="line">aggreation_test 4     p      STARTED      1    5kb 127.0.0.1 node-178</span><br><span class="line">aggreation_test 0     p      STARTED      0   130b 127.0.0.1 node-177</span><br><span class="line">aggreation_test 0     r      STARTED      0   130b 10.10.18.179 node-179</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="字段数据类型"><a href="#字段数据类型" class="headerlink" title="字段数据类型"></a>字段数据类型</h2><p>核心数据类型：</p>
<ul>
<li>字符串类型： <code>string</code> (6.0将会移除) 、 <code>text</code> 、 <code>keyword</code></li>
<li>数字型数据类型： <code>long</code> <code>integer</code> <code>short</code> <code>byte</code> <code>double</code> <code>float</code></li>
<li>日期型数据类型： <code>date</code></li>
<li>布尔型数据类型： <code>boolean</code></li>
<li>二进制数据类型： <code>binary</code></li>
</ul>
<p>复杂数据类型：</p>
<ul>
<li>对象数据类型： <code>object</code> ,单独的JSON对象</li>
<li>嵌套数据类型： <code>nested</code>  JSON对象的数组</li>
</ul>
<p>地理数据类型：</p>
<ul>
<li>地理点数据类型： <code>geo_point</code>  经纬点</li>
<li>地理形状数据类型： <code>geo_shape</code> 多边形的复杂地理形状</li>
</ul>
<h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><h3 id="索引管理"><a href="#索引管理" class="headerlink" title="索引管理"></a>索引管理</h3><h4 id="创建索引"><a href="#创建索引" class="headerlink" title="创建索引"></a>创建索引</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT &apos;http://127.0.0.1:9200/school?pretty&apos;</span><br></pre></td></tr></table></figure>
<p><strong>创建索引时修改分片和副本的数量</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT &apos;http://127.0.0.1:9200/school?pretty&apos; -d &apos;</span><br><span class="line">&#123;</span><br><span class="line">    &quot;settings&quot;:&#123;</span><br><span class="line">        &quot;number_of_shards&quot;:3,</span><br><span class="line">        &quot;number_of_replicas&quot;:0</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&apos;</span><br></pre></td></tr></table></figure>
<p><strong>可以通过api 修改副本的数量</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT &apos;http://127.0.0.1:9200/school/_settings?pretty&apos; -d &apos;</span><br><span class="line">&#123;</span><br><span class="line">    &quot;number_of_replicas&quot;: 1</span><br><span class="line">&#125;</span><br><span class="line">&apos;</span><br></pre></td></tr></table></figure>
<h4 id="打开-关闭索引"><a href="#打开-关闭索引" class="headerlink" title="打开/关闭索引"></a>打开/关闭索引</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST &apos;http://127.0.0.1:9200/school/_open?pretty&apos;</span><br><span class="line">curl -XPOST &apos;http://127.0.0.1:9200/school/_close?pretty&apos;</span><br></pre></td></tr></table></figure>
<p>关闭的索引只能显示索引元数据信息，不能进行读写操作</p>
<h4 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a>删除索引</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XDELETE &apos;http://127.0.0.1:9200/school&apos;</span><br></pre></td></tr></table></figure>
<h3 id="索引映射管理"><a href="#索引映射管理" class="headerlink" title="索引映射管理"></a>索引映射管理</h3><h4 id="增加映射"><a href="#增加映射" class="headerlink" title="增加映射"></a>增加映射</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT &apos;http://127.0.0.1:9200/school?pretty&apos; -d &apos;</span><br><span class="line">&#123;</span><br><span class="line">    &quot;mappings&quot;:&#123;</span><br><span class="line">        &quot;student&quot;: &#123;</span><br><span class="line">            &quot;properties&quot;: &#123;</span><br><span class="line">                &quot;first_name&quot;: &#123;&quot;type&quot;: &quot;text&quot;&#125;,</span><br><span class="line">                &quot;last_name&quot;: &#123;&quot;type&quot;: &quot;text&quot;&#125;,</span><br><span class="line">                &quot;age&quot;: &#123;&quot;type&quot;: &quot;integer&quot;&#125;,</span><br><span class="line">                &quot;about&quot;: &#123;&quot;type&quot;: &quot;text&quot;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&apos;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT &apos;http://127.0.0.1:9200/school/_mapping/teacher?pretty&apos; -d &apos;</span><br><span class="line">&#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &#123;&quot;type&quot;: &quot;text&quot;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&apos;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT &apos;http://127.0.0.1:9200/aggreation_test/_mapping/order?pretty&apos; -d &apos;</span><br><span class="line">&#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;from&quot;: &#123;&quot;type&quot;: &quot;integer&quot;, &quot;index&quot;:&quot;not_analyzed&quot;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&apos;</span><br></pre></td></tr></table></figure>
<h4 id="获取映射"><a href="#获取映射" class="headerlink" title="获取映射"></a>获取映射</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET &apos;http://127.0.0.1:9200/school/_mappings/student?pretty&apos;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET &apos;http://127.0.0.1:9200/school/_mapping/student/field/first_name?pretty&apos;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XHEAD &apos;127.0.0.1:9200/school/_mapping/student?pretty&apos;</span><br></pre></td></tr></table></figure>
<h2 id="文档管理"><a href="#文档管理" class="headerlink" title="文档管理"></a>文档管理</h2><h3 id="插入-更新-数据"><a href="#插入-更新-数据" class="headerlink" title="插入(更新)数据"></a>插入(更新)数据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT &apos;http://127.0.0.1:9200/school/student/3?pretty&apos; -d &apos;</span><br><span class="line">&#123;</span><br><span class="line">    &quot;first_name&quot; : &quot;John&quot;,</span><br><span class="line">    &quot;last_name&quot; :  &quot;Smith&quot;,</span><br><span class="line">    &quot;age&quot; :        25,</span><br><span class="line">    &quot;about&quot; :      &quot;I love to go rock climbing&quot;</span><br><span class="line">&#125;</span><br><span class="line">&apos;</span><br></pre></td></tr></table></figure>
<p>返回结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"_index"</span> : <span class="string">"school"</span>,</span><br><span class="line">  <span class="attr">"_type"</span> : <span class="string">"student"</span>,</span><br><span class="line">  <span class="attr">"_id"</span> : <span class="string">"1"</span>,</span><br><span class="line">  <span class="attr">"_version"</span> : <span class="number">2</span>,</span><br><span class="line">  <span class="attr">"result"</span> : <span class="string">"updated"</span>,</span><br><span class="line">  <span class="attr">"_shards"</span> : &#123;</span><br><span class="line">    <span class="attr">"total"</span> : <span class="number">2</span>,</span><br><span class="line">    <span class="attr">"successful"</span> : <span class="number">2</span>,</span><br><span class="line">    <span class="attr">"failed"</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"created"</span> : <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第二次调用返回：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"_index"</span> : <span class="string">"school"</span>,</span><br><span class="line">  <span class="attr">"_type"</span> : <span class="string">"student"</span>,</span><br><span class="line">  <span class="attr">"_id"</span> : <span class="string">"1"</span>,</span><br><span class="line">  <span class="attr">"_version"</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"result"</span> : <span class="string">"created"</span>,     <span class="comment">//NOTE</span></span><br><span class="line">  <span class="attr">"_shards"</span> : &#123;</span><br><span class="line">    <span class="attr">"total"</span> : <span class="number">2</span>,</span><br><span class="line">    <span class="attr">"successful"</span> : <span class="number">2</span>,</span><br><span class="line">    <span class="attr">"failed"</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"created"</span> : <span class="literal">false</span>         <span class="comment">//NOTE</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>注意更新、插入返回的结果表现形式的区别</strong></p>
<h3 id="Update"><a href="#Update" class="headerlink" title="Update"></a>Update</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST test/type1/1/_update</span><br><span class="line">&#123;</span><br><span class="line">    &quot;doc&quot; : &#123;</span><br><span class="line">        &quot;name&quot; : &quot;new_name&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="bulk"><a href="#bulk" class="headerlink" title="bulk"></a>bulk</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT &apos;http://127.0.0.1:9200/_bulk&apos; -d &apos;</span><br><span class="line">&#123; &quot;index&quot; : &#123; &quot;_index&quot; : &quot;aggreation_test&quot;, &quot;_type&quot; : &quot;student&quot;, &quot;_id&quot; : &quot;1&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;stu1&quot;, &quot;age&quot;:21, &quot;socre&quot;: 81 &#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123; &quot;_index&quot; : &quot;aggreation_test&quot;, &quot;_type&quot; : &quot;student&quot;, &quot;_id&quot; : &quot;2&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;stu2&quot;, &quot;age&quot;:22, &quot;socre&quot;: 66 &#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123; &quot;_index&quot; : &quot;aggreation_test&quot;, &quot;_type&quot; : &quot;student&quot;, &quot;_id&quot; : &quot;3&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;stu3&quot;, &quot;age&quot;:23, &quot;socre&quot;: 111 &#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123; &quot;_index&quot; : &quot;aggreation_test&quot;, &quot;_type&quot; : &quot;student&quot;, &quot;_id&quot; : &quot;4&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;stu4&quot;, &quot;age&quot;:22, &quot;socre&quot;: 88 &#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123; &quot;_index&quot; : &quot;aggreation_test&quot;, &quot;_type&quot; : &quot;student&quot;, &quot;_id&quot; : &quot;5&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;stu5&quot;, &quot;age&quot;:21, &quot;socre&quot;: 73 &#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123; &quot;_index&quot; : &quot;aggreation_test&quot;, &quot;_type&quot; : &quot;student&quot;, &quot;_id&quot; : &quot;6&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;stu6&quot;, &quot;age&quot;:24, &quot;socre&quot;: 99 &#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123; &quot;_index&quot; : &quot;aggreation_test&quot;, &quot;_type&quot; : &quot;student&quot;, &quot;_id&quot; : &quot;7&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;stu7&quot;, &quot;age&quot;:27, &quot;socre&quot;: 81 &#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123; &quot;_index&quot; : &quot;aggreation_test&quot;, &quot;_type&quot; : &quot;student&quot;, &quot;_id&quot; : &quot;8&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;stu8&quot;, &quot;age&quot;:26, &quot;socre&quot;: 81 &#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123; &quot;_index&quot; : &quot;aggreation_test&quot;, &quot;_type&quot; : &quot;student&quot;, &quot;_id&quot; : &quot;9&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;stu9&quot;, &quot;age&quot;:25, &quot;socre&quot;: 111 &#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123; &quot;_index&quot; : &quot;aggreation_test&quot;, &quot;_type&quot; : &quot;student&quot;, &quot;_id&quot; : &quot;10&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;stu10&quot;, &quot;age&quot;:29, &quot;socre&quot;: 99 &#125;</span><br><span class="line">&apos;</span><br></pre></td></tr></table></figure>
<h3 id="查询文档"><a href="#查询文档" class="headerlink" title="查询文档"></a>查询文档</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET &apos;http://127.0.0.1:9200/school/student/1&apos;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET  -u elastic:changeme &apos;192.168.140.129:9200/corp/employee/1/_source&apos;  # 只返回_source</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET  -u elastic:changeme &apos;192.168.140.129:9200/corp/employee/1?_source=age&apos;  #只返回age字段的内容</span><br></pre></td></tr></table></figure>
<h3 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XDELETE &apos;http://127.0.0.1:9200/school/student/1&apos;</span><br></pre></td></tr></table></figure>
<h3 id="清空文档"><a href="#清空文档" class="headerlink" title="清空文档"></a>清空文档</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST &apos;http://127.0.0.1:9200/das_customer_service/work_order/_delete_by_query?pretty&apos; -d &apos;</span><br><span class="line">&#123;</span><br><span class="line">&quot;query&quot; :&#123;</span><br><span class="line">    &quot;match_all&quot;:&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&apos;</span><br></pre></td></tr></table></figure>
<h3 id="搜索"><a href="#搜索" class="headerlink" title="搜索"></a>搜索</h3><p><strong>计算集群中文档的数量</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET   &apos;127.0.0.1:9200/_count?pretty&apos; -d &apos;</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&apos;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.mervyntang.com/48.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mervyn">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mervyn's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/48.html" itemprop="url">Elasticsearch 安装部署</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-02-27T15:00:00+08:00">
                2018-02-27
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/NoSQL/" itemprop="url" rel="index">
                    <span itemprop="name">NoSQL</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Elasticsearch-安装部署"><a href="#Elasticsearch-安装部署" class="headerlink" title="Elasticsearch 安装部署"></a>Elasticsearch 安装部署</h1><h3 id="安装依赖（已安装java8的机器可忽略此步）"><a href="#安装依赖（已安装java8的机器可忽略此步）" class="headerlink" title="安装依赖（已安装java8的机器可忽略此步）"></a>安装依赖（已安装java8的机器可忽略此步）</h3><p>依赖:  java &gt;= 8, Only Oracle’s Java and the OpenJDK are supported. 推荐安装 1.8.0_73 or later</p>
<ol>
<li><a href="https://www.java.com/zh_CN/download/manual.jsp" rel="external nofollow noopener noreferrer" target="_blank">https://www.java.com/zh_CN/download/manual.jsp</a>  下载对应系统的java</li>
<li>tar zxvf jre-8u131-linux-x64.tar.gz</li>
<li>将该目录放置到想要安装的目录，然后加入linux环境变量$PATH 中</li>
</ol>
<h3 id="安装、启动es"><a href="#安装、启动es" class="headerlink" title="安装、启动es"></a>安装、启动es</h3><h3 id="单机部署"><a href="#单机部署" class="headerlink" title="单机部署"></a>单机部署</h3><p><a href="https://www.elastic.co/downloads/elasticsearch" rel="external nofollow noopener noreferrer" target="_blank">https://www.elastic.co/downloads/elasticsearch</a> 下载编译好的二进制文件，解压后即可使用</p>
<p>如果系统存在多个java环境，需要在启动先指定JAVA_HOME，然后在进行启动，如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export JAVA_HOME=/usr/local/java1.8.0 # 如已设置 JAVA_HOME 可以忽略此步</span><br><span class="line">export ES_HEAP_SIZE=10g  #修改 Elasticsearch 的堆内存</span><br><span class="line">bin/elasticsearch -d # 其中-d  表示 es 已守护进程的方式启动</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl &apos;http://localhost:9200/?pretty&apos; #测试es是否启动成功</span><br></pre></td></tr></table></figure>
<h3 id="集群部署-以两台服务器为例"><a href="#集群部署-以两台服务器为例" class="headerlink" title="集群部署,以两台服务器为例"></a>集群部署,以两台服务器为例</h3><p>分别配置<code>elasticsearch.yml</code>文件</p>
<ul>
<li>服务器A  ip:192.168.140.129</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cluster.name：app-demo</span><br><span class="line">node.name: node-1</span><br><span class="line">network.host: 192.168.140.129</span><br><span class="line">discovery.zen.ping.unicast.hosts: [&quot;192.168.140.128&quot;]</span><br></pre></td></tr></table></figure>
<ul>
<li>服务器B  ip:192.168.140.128</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cluster.name：app-demo</span><br><span class="line">node.name: node-2</span><br><span class="line">network.host: 192.168.140.128</span><br><span class="line">discovery.zen.ping.unicast.hosts: [&quot;192.168.140.129&quot;]</span><br></pre></td></tr></table></figure>
<p>分别启动即可</p>
<p><code>curl  -u elastic &#39;192.168.140.129:9200/_cat/nodes?v&#39;  #测试集群状态</code></p>
<p><strong>注意： ES启动时不能以 root 用户启动</strong></p>
<h3 id="动态变更配置"><a href="#动态变更配置" class="headerlink" title="动态变更配置"></a>动态变更配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT /_cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">    &quot;persistent&quot; : &#123;</span><br><span class="line">        &quot;discovery.zen.minimum_master_nodes&quot; : 2  # 永久设置会在全集群重启时存活下来</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;transient&quot; : &#123;</span><br><span class="line">        &quot;indices.store.throttle.max_bytes_per_sec&quot; : &quot;50mb&quot; #临时设置会在第一次全集群重启后被移除</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ES配置文件"><a href="#ES配置文件" class="headerlink" title="ES配置文件"></a>ES配置文件</h3><p>配置文件默认在 <code>$ES_HOME/config/</code> ，也可以在启动时指定加载对应的配置文件</p>
<p>es包含配置文件 <code>elasticsearch.yml</code> (配置 <code>elasticsearch</code> ) 、<code>log4j2.properties</code>（ es 日志相关配置 ）和 <code>jvm.options</code></p>
<p><strong>elasticsearch.yml</strong></p>
<p>该文件yaml格式支持两种配置格式</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">path:</span></span><br><span class="line">    <span class="attr">data:</span> <span class="string">/var/lib/elasticsearch</span></span><br><span class="line">    <span class="attr">logs:</span> <span class="string">/var/log/elasticsearch</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">path.data: /var/lib/elasticsearch</span><br><span class="line">path.logs: /var/log/elasticsearch</span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>path.data</code>   <strong>这个强烈建议进行修改</strong></p>
<p>  设置索引数据的存储路径，默认是es根目录下的data文件夹，可以设置多个存储路径，用逗号隔开，例：</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">path.data: /path/to/data1,/path/to/data2</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>path.logs</code>  <strong>这个强烈建议进行修改</strong><br>  设置日志文件的存储路径，默认是es根目录下的logs文件夹</p>
</li>
<li><p><code>path.plugins</code><br>  插件路径</p>
</li>
<li><p><code>cluster.name: elasticsearch</code><br>  配置es的集群名称，默认是elasticsearch，es会自动发现在同一网段下的es，如果在同一网段下有多个集群，就可以用这个属性来区分不同的集群。（<strong>最好</strong> 改成一个适当的名字来描述该集群的作用，同时也能防止同一个网段的其他机器测试时影影响）</p>
</li>
<li><p><code>node.name: node-1</code><br>  节点名，默认为uuid前七位，也可以设置为主机的HOSTNAME  ， 如 <code>node.name: ${HOSTNAME}</code></p>
</li>
<li><p><code>bootstrap.memory_lock: true</code><br>  设置为true来锁住内存。因为当jvm开始swapping时es的效率 会降低，所以要保证它不swap，可以把ES_MIN_MEM和ES_MAX_MEM两个环境变量设置成同一个值，并且保证机器有足够的内存分配给es。</p>
</li>
<li><p><code>network.host: 0.0.0.0</code><br>  绑定本机网络地址，设置了此参数，es假设从开发模式变成成产模式，如果配置了0.0.0.0 最好开启防火墙防止外部ip直接连接</p>
</li>
<li><p><code>discovery.zen.ping.unicast.hostsedit</code></p>
<p>   这个设置把组播的自动发现给关闭了，为了防止其他机器上的节点自动连入</p>
</li>
<li><p><code>discovery.zen.minimum_master_nodes</code><br>  设置这个参数来保证集群中的节点可以知道其它N个有master资格的节点。默认为1.</p>
<p>  此设置应该始终被配置为 master 候选节点的法定个数（大多数个）。法定个数就是 <code>( master 候选节点个数 / 2) + 1</code> 。 这里有几个例子：</p>
<ul>
<li>如果你有 10 个节点（能保存数据，同时能成为 master），法定数就是 <code>6</code> 。</li>
<li>如果你有 3 个候选 master 节点，和 100 个 data 节点，法定数就是 <code>2</code> ，你只要数数那些可以做 master 的节点数就可以了。</li>
<li>如果你有两个节点，你遇到难题了。法定数当然是 <code>2</code> ，但是这意味着如果有一个节点挂掉，你整个集群就不可用了。 设置成 <code>1</code> 可以保证集群的功能，但是就无法保证集群脑裂了，像这样的情况，你最好至少保证有 3 个节点。</li>
</ul>
</li>
<li><p><code>gateway.recover_after_nodes: 8</code></p>
<p>  这将阻止 Elasticsearch 在存在至少 8 个节点（数据节点或者 master 节点）之前进行数据恢复。 这个值的设定取决于个人喜好：整个集群提供服务之前你希望有多少个节点在线？这种情况下，我们设置为 8，这意味着至少要有 8 个节点，该集群才可用。</p>
</li>
<li><p><code>gateway.recover_after_time: 5m</code></p>
</li>
<li><p><code>gateway.expected_nodes: 10</code></p>
<p>  这意味着 Elasticsearch 会采取如下操作：</p>
<ul>
<li>等待集群至少存在 8 个节点</li>
<li><p>等待 5 分钟，或者10 个节点上线后，才进行数据恢复，这取决于哪个条件先达到。</p>
<p>以上三个设置可以在集群重启的时候避免过多的分片交换。这可能会让数据恢复从数个小时缩短为几秒钟。</p>
</li>
</ul>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.mervyntang.com/159.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mervyn">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mervyn's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/159.html" itemprop="url">PHP使用SPL内置迭代器递归遍历目录</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-02-26T01:21:00+08:00">
                2018-02-26
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/" itemprop="url" rel="index">
                    <span itemprop="name">PHP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>使用<code>PHP</code> 的 <code>SPL</code> 库的迭代器可以很方便的递归遍历某个目录及其子目录下的文件，代码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$dir = <span class="string">'~/workspace'</span>;</span><br><span class="line">$files = <span class="keyword">new</span> RecursiveIteratorIterator(<span class="keyword">new</span> RecursiveDirectoryIterator($dir));</span><br><span class="line"><span class="keyword">foreach</span> ( $files <span class="keyword">as</span> $file ) &#123;</span><br><span class="line">    <span class="keyword">echo</span> $file-&gt;__toString().<span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>参考：<br><a href="http://php.net/manual/en/spl.iterators.php" rel="external nofollow noopener noreferrer" target="_blank">http://php.net/manual/en/spl.iterators.php</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.mervyntang.com/56.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mervyn">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mervyn's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/56.html" itemprop="url">开发一个本地 composer 包</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-02-23T15:27:00+08:00">
                2018-02-23
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/" itemprop="url" rel="index">
                    <span itemprop="name">PHP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>当我们用版本控制系统（如 git 、github 等）去开发一个 <code>composer</code> 包时是比较好的一种方式，但是当我们项目启动刚开始的时候，需要频繁地进行提交、更新操作。如何在没有 github 、git 、svn 之类的环境下如何开发一个自己的 composer 包就是我们接下来要讲解的内容了。</p>
<h2 id="创建目录、composer初始化"><a href="#创建目录、composer初始化" class="headerlink" title="创建目录、composer初始化"></a>创建目录、composer初始化</h2><p>首先为我们的要开发的composer包初始化一个目录,如下操作：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd ~/workspace/www</span><br><span class="line">mkdir DateHelper</span><br><span class="line">composer init</span><br></pre></td></tr></table></figure>
<p>然后按照composer的提示填写对应composer包的内容即可，执行完后生成的 <code>composer.json</code> 内容类似如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"mervyn1205/date-helper"</span>,</span><br><span class="line">    <span class="attr">"description"</span>:<span class="string">"a light date helper for php"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"library"</span>,</span><br><span class="line">    <span class="attr">"license"</span>: <span class="string">"MIT"</span>,</span><br><span class="line">    <span class="attr">"minimum-stability"</span>: <span class="string">"dev"</span>,</span><br><span class="line">    <span class="attr">"authors"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"Mervyn"</span>,</span><br><span class="line">            <span class="attr">"email"</span>: <span class="string">"404245127@qq.com"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"require"</span>: &#123;</span><br><span class="line">        <span class="attr">"php"</span>: <span class="string">"&gt;=5.4.0"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"autoload"</span>: &#123;</span><br><span class="line">        <span class="attr">"psr-4"</span>: &#123;</span><br><span class="line">            <span class="attr">"DateHelper\\"</span>: <span class="string">"src\\"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="开发该composer"><a href="#开发该composer" class="headerlink" title="开发该composer"></a>开发该composer</h2><p>DateHelper目录结构如下：</p>
<blockquote>
<p>  ├── composer.json<br>  ├── LICENSE<br>  ├── README.md<br>  ├── src<br>  │   └── DateHelper.php<br>  └── tests</p>
</blockquote>
<p>其中 <code>src</code> 目录就是 <code>composer</code> 包实际代码放置的目录了。</p>
<p>这里需要注意的是 composer 包对应的命名空间。</p>
<h2 id="本地使用composer包"><a href="#本地使用composer包" class="headerlink" title="本地使用composer包"></a>本地使用composer包</h2><p>进入需要应用该 composer 包的项目目录，引用该composer包即可。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /www/web/project</span><br><span class="line">touch composer.json</span><br></pre></td></tr></table></figure>
<p>composer.json 内容如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"require-dev"</span>: &#123;</span><br><span class="line">        <span class="attr">"mervyn1205/date-helper"</span>: <span class="string">"@dev"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"repositories"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"path"</span>,</span><br><span class="line">            <span class="attr">"url"</span>: <span class="string">"~/workspace/www/DateHelper"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行<code>composer install</code> 然后加载composer的autoload文件即可。</p>
<p>如果你的composer包已经开发完毕，可以提交到 <a href="https://packagist.org" rel="external nofollow noopener noreferrer" target="_blank">https://packagist.org</a> ，这样别人就可以直接通过 composer require 的方式引用你开发的 composer 包了。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.mervyntang.com/83.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mervyn">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mervyn's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/83.html" itemprop="url">阿里云 ssh 免密码登录</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-10T15:44:00+08:00">
                2017-12-10
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="配置ssh-key-登录"><a href="#配置ssh-key-登录" class="headerlink" title="配置ssh key 登录"></a>配置ssh key 登录</h2><ol>
<li><p>生成公钥和私钥</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -C "Mervyn"</span><br></pre></td></tr></table></figure>
</li>
<li><p>将公钥上传至服务器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp id_rsa.pub username@server:~/.ssh/id_rsa.pub</span><br></pre></td></tr></table></figure>
</li>
<li><p>登录到服务器（此时需要输入密码)并创建相应的目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ssh username@server</span><br><span class="line">mkdir ~/.ssh</span><br><span class="line">chmod 700 ~/.ssh</span><br><span class="line">touch ~/.ssh/authorized_keys</span><br><span class="line">chmod 644 ~/.ssh/authorized_keys</span><br></pre></td></tr></table></figure>
</li>
<li><p>将公钥加入服务器认证</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd ~/.ssh</span><br><span class="line">cat id_rsa.pub &gt;&gt; authorized_keys</span><br><span class="line">rm id_rsa.pub</span><br></pre></td></tr></table></figure>
</li>
<li><p>退出再次登录即可无密码登录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh username@server</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="禁止root用户通过密码登录并修改ssh登录端口"><a href="#禁止root用户通过密码登录并修改ssh登录端口" class="headerlink" title="禁止root用户通过密码登录并修改ssh登录端口"></a>禁止root用户通过密码登录并修改ssh登录端口</h2><ol>
<li>修改配置文件 <code>vi /etc/ssh/sshd_config</code></li>
</ol>
<ul>
<li>修改 <code>PermitRootLogin</code> 由 <code>yes</code> 改为 <code>no</code> , 并且去掉前面的注释符</li>
<li>修改 <code>Port</code> 由22 改为其他数值</li>
</ul>
<ol start="2">
<li>重启sshd服务<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service sshd restart</span><br></pre></td></tr></table></figure>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.mervyntang.com/25.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mervyn">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mervyn's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/25.html" itemprop="url">Docker常用命令</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-11-13T17:19:00+08:00">
                2017-11-13
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/DevOps/" itemprop="url" rel="index">
                    <span itemprop="name">DevOps</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="images相关命令"><a href="#images相关命令" class="headerlink" title="images相关命令"></a>images相关命令</h2><h3 id="编译一个镜像"><a href="#编译一个镜像" class="headerlink" title="编译一个镜像"></a>编译一个镜像</h3><p>根据当前目录下的Dockerfile创建<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ls</span><br><span class="line">docker build -t friendlyhello .</span><br></pre></td></tr></table></figure></p>
<h3 id="列出所有的镜像"><a href="#列出所有的镜像" class="headerlink" title="列出所有的镜像"></a>列出所有的镜像</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜ docker images</span><br><span class="line">REPOSITORY               TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">friendlyhello            latest              2e202abc6a75        23 hours ago        148MB</span><br></pre></td></tr></table></figure>
<p>列出本机所有镜像<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker image ls -a</span><br></pre></td></tr></table></figure></p>
<h3 id="启动镜像"><a href="#启动镜像" class="headerlink" title="启动镜像"></a>启动镜像</h3><p>启动镜像的同时映射本地4000到容器的80端口</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 4000:80 friendlyhello</span><br><span class="line"><span class="comment">#等价于</span></span><br><span class="line">docker run -p 4000:80 friendlyhello:latest</span><br><span class="line"><span class="comment">#以守护进程的方式启动该镜像</span></span><br><span class="line">docker run -d -p 4000:80 friendlyhello</span><br></pre></td></tr></table></figure>
<h3 id="拉取远端镜像仓库并执行"><a href="#拉取远端镜像仓库并执行" class="headerlink" title="拉取远端镜像仓库并执行"></a>拉取远端镜像仓库并执行</h3><p>如果镜像不在本地机器上，则从远端仓库中拉取到本地<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 4000:80 username/repository:tag</span><br></pre></td></tr></table></figure></p>
<p><strong>PS:如果没有指定tag，则默认tag为latest</strong></p>
<h3 id="给某个镜像打tag"><a href="#给某个镜像打tag" class="headerlink" title="给某个镜像打tag"></a>给某个镜像打tag</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker tag image  username/repository:tag</span><br></pre></td></tr></table></figure>
<p>例如：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ docker tag friendlyhello  mervyn1205/get-started:part3</span><br></pre></td></tr></table></figure></p>
<h3 id="发布镜像"><a href="#发布镜像" class="headerlink" title="发布镜像"></a>发布镜像</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker push username/repository:tags</span><br></pre></td></tr></table></figure>
<h3 id="删除镜像"><a href="#删除镜像" class="headerlink" title="删除镜像"></a>删除镜像</h3><p>删除指定镜像<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker image rm &lt;image id&gt;</span><br></pre></td></tr></table></figure></p>
<p>删除本机所有镜像<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker image rm $(docker image ls -a -q)</span><br></pre></td></tr></table></figure></p>
<h2 id="container相关命令"><a href="#container相关命令" class="headerlink" title="container相关命令"></a>container相关命令</h2><h3 id="列出正在运行的容器"><a href="#列出正在运行的容器" class="headerlink" title="列出正在运行的容器"></a>列出正在运行的容器</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker container ls</span><br><span class="line"><span class="comment"># 列出所有的容器，包括未执行的</span></span><br><span class="line">docker container ls -a</span><br></pre></td></tr></table></figure>
<h3 id="列出某个正在运行的容器的IP"><a href="#列出某个正在运行的容器的IP" class="headerlink" title="列出某个正在运行的容器的IP"></a>列出某个正在运行的容器的IP</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker inspect --format=<span class="string">"&#123;&#123; .NetworkSettings.IPAddress &#125;&#125;"</span> CONTAINER_ID</span><br><span class="line"></span><br><span class="line">docker inspect -f <span class="string">'&#123;&#123;range .NetworkSettings.Networks&#125;&#125;&#123;&#123;.IPAddress&#125;&#125;&#123;&#123;end&#125;&#125;'</span> CONTAINER_ID</span><br></pre></td></tr></table></figure>
<h3 id="停止某个正在运行的容器"><a href="#停止某个正在运行的容器" class="headerlink" title="停止某个正在运行的容器"></a>停止某个正在运行的容器</h3><p>优雅的停止指定容器<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker container stop CONTAINER_ID</span><br></pre></td></tr></table></figure></p>
<p>强制关闭指定容器<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker container <span class="built_in">kill</span> &lt;<span class="built_in">hash</span>&gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="删除容器"><a href="#删除容器" class="headerlink" title="删除容器"></a>删除容器</h3><p>从本地机器上删除指定容器<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker container rm &lt;<span class="built_in">hash</span>&gt;</span><br></pre></td></tr></table></figure></p>
<p>删除所有容器<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker container rm $(docker container ls -a -q)</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpeg" alt="Mervyn">
            
              <p class="site-author-name" itemprop="name">Mervyn</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">62</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">16</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">37</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/Mervyn1205" target="_blank" title="GitHub" rel="external nofollow noopener noreferrer">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:ttz5127@163.com" target="_blank" title="E-Mail" rel="external nofollow noopener noreferrer">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          
            <div class="cc-license motion-element" itemprop="license">
              <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" target="_blank" rel="external nofollow noopener noreferrer">
                <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons">
              </a>
            </div>
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.mervyntang.com" title="Mervyn" target="_blank">Mervyn</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://mervyn1205.github.io/linux-command" title="Linux 命令查找" target="_blank" rel="external nofollow noopener noreferrer">Linux 命令查找</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Mervyn</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io" rel="external nofollow noopener noreferrer">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next" rel="external nofollow noopener noreferrer">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  







<!-- LOCAL: You can save these files to your site and update links -->
    
        
        <link rel="stylesheet" href="https://aimingoo.github.io/gitmint/style/default.css">
        <script src="https://aimingoo.github.io/gitmint/dist/gitmint.browser.js"></script>
    
<!-- END LOCAL -->

    
      <style>
        a.gitment-editor-footer-tip { display: none; }
        .gitment-container.gitment-footer-container { display: none; }
      </style>
    

    







  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  

  

  

</body>
</html>
